{% extends 'randomizer/layouts/default.html' %}

{% block content %}
    {% include 'randomizer/_rom_base.html' %}
    {% include 'randomizer/_rom_loader.html' %}

    <div id="seed-generate" class="panel panel-success" style="display:none">
        <div class="panel-heading panel-heading-btn">
            <h3 class="panel-title pull-left">Generate Randomized Game (v{{ version|default:'UNKNOWN' }})</h3>
            <div class="btn-toolbar pull-right">
                {% include 'randomizer/_rom_settings_button.html' %}
            </div>
            <div class="clearfix"></div>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6 pb-5">
                    <div class="input-group" role="group">
                        <span class="input-group-addon">Randomization Mode</span>
                        <select title="" id="mode" class="form-control selectpicker">
                            <option value="full">Full</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="panel panel-info panel-collapse collapse" id="custom-mode-settings">
                <div class="panel-heading">
                    <h4 class="panel-title">Custom Mode Settings</h4>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-6 pb-5">
                            <input id="randomize-character-stats" type="checkbox" value="true" checked
                                   data-toggle="toggle"
                                   data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                            <label for="randomize-character-stats">Character stats</label>
                        </div>
                        <div class="col-md-6 pb-5">
                            <input id="randomize-drops" type="checkbox" value="true" checked data-toggle="toggle"
                                   data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                            <label for="randomize-drops">Drops</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 pb-5">
                            <input id="randomize-enemy-formations" type="checkbox" value="true" checked
                                   data-toggle="toggle"
                                   data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                            <label for="randomize-enemy-formations">Enemy formations</label>
                        </div>
                        <div class="col-md-6 pb-5">
                            <input id="randomize-monsters" type="checkbox" value="true" checked data-toggle="toggle"
                                   data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                            <label for="randomize-monsters">Monsters</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 pb-5">
                            <input id="randomize-shops" type="checkbox" value="true" checked data-toggle="toggle"
                                   data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                            <label for="randomize-shops">Shops</label>
                        </div>
                        <div class="col-md-6 pb-5">
                            <input id="randomize-equipment" type="checkbox" value="true" checked data-toggle="toggle"
                                   data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                            <label for="randomize-equipment">Equipment stats and allowed characters</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 pb-5">
                            <input id="randomize-spell-stats" type="checkbox" value="true" checked data-toggle="toggle"
                                   data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                            <label for="randomize-spell-stats">Character spell stats</label>
                        </div>
                        <div class="col-md-6 pb-5">
                            <input id="randomize-spell-lists" type="checkbox" value="true" checked data-toggle="toggle"
                                   data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                            <label for="randomize-spell-lists">Character spell lists</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 pb-5">
                    <div class="input-group" role="group">
                        <span class="input-group-addon">Seed</span>
                        <input type="text" id="seed" class="seed form-control" placeholder="random">
                        <span class="input-group-btn">
                            <button id="seed-clear" class="btn btn-default" type="button"><span
                                    class="glyphicon glyphicon-remove"></span></button>
					    </span>
                    </div>
                </div>
            </div>
            {% include 'randomizer/_rom_settings.html' %}
        </div>
        <div class="panel-footer">
            <div class="row">
                <div class="col-md-6">
                    <div class="btn-group btn-flex" role="group">
                        <button name="generate" class="btn btn-success generate-btn" disabled>Generate ROM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="seed-details" class="info panel panel-info" style="display:none">
        <div class="panel-heading"><h3 class="panel-title">Game Details</h3></div>
        <div class="panel-body">
            {% include 'randomizer/_rom_info.html' %}
            <div class="col-md-6">
                <div class="row">
                    <button name="save_rom" class="btn btn-success btn-save-rom" disabled>Save Rom</button>
                    <button name="save_wad" class="btn btn-success btn-save-wad" disabled>Save Wad</button>
                </div>
            </div>
        </div>
    </div>
    <form id="config" style="display:none">
        {% csrf_token %}
        <input type="hidden" name="region" id="form_region" value=""/>
        <input type="hidden" name="seed" id="form_seed" value=""/>
        <input type="hidden" name="mode" id="form_mode" value="full"/>
        <input type="hidden" name="randomize_character_stats" id="form_randomize_character_stats" value="true"/>
        <input type="hidden" name="randomize_drops" id="form_randomize_drops" value="true"/>
        <input type="hidden" name="randomize_enemy_formations" id="form_randomize_enemy_formations" value="true"/>
        <input type="hidden" name="randomize_monsters" id="form_randomize_monsters" value="true"/>
        <input type="hidden" name="randomize_shops" id="form_randomize_shops" value="true"/>
        <input type="hidden" name="randomize_equipment" id="form_randomize_equipment" value="true"/>
        <input type="hidden" name="randomize_spell_stats" id="form_randomize_spell_stats" value="true"/>
        <input type="hidden" name="randomize_spell_lists" id="form_randomize_spell_lists" value="true"/>
        <input type="hidden" name="cutscene_skip" id="form_cutscene_skip" value="true"/>
    </form>

    <script>
        function applySeed(rom, seed) {
            return new Promise(function (resolve, reject) {
                $("#form_region").val(rom.region);
                $("#form_seed").val(seed);
                $.post("{% url 'randomizer:generate' %}", $("#config").serialize(), function (patch) {
                    rom.parsePatch(patch.patch)
                        .then(rom.setCutsceneSkip($("#cutscene-skip").prop("checked")))
                        .then(function (rom) {
                            resolve({rom: rom, patch: patch});
                        });
                }, "json").fail(reject);
            });
        }

        function seedFailed() {
            $(".generate-btn").html("Generate ROM").prop("disabled", false);
            $(".alert .message").html("Failed Creating Seed :(");
            $(".alert").show().delay(2000).fadeOut("slow");
        }

        function seedApplied(data) {
            return new Promise(function (resolve) {
                $(".generate-btn").html("Generate").prop("disabled", false);
                $(".btn-save-rom").prop("disabled", false);
                if (wad.valid) {
                    $(".btn-save-wad").prop("disabled", false);
                } else {
                    $(".btn-save-wad").prop("disabled", true);
                }
                parseInfoFromPatch(data.patch);
                data.rom.logic = data.patch.logic;
                data.rom.mode = data.patch.mode;
                data.rom.seed = data.patch.seed;
                data.rom.hash = data.patch.hash;
                resolve(rom);
            });
        }

        $(function () {
            $("#seed-clear").click(function () {
                $("#seed").val("");
            });

            // Randomization mode
            $("#mode").change(function () {
                $(".info").hide();
                localforage.setItem("rom.mode", $(this).val());
                $("#form_mode").val($(this).val());
                if ($(this).val() === "custom") {
                    $("#custom-mode-settings").collapse("show");
                } else {
                    $("#custom-mode-settings").collapse("hide");
                }
            }).change();
            localforage.getItem("rom.mode").then(function (value) {
                if (value === null) return;
                $("#mode").val(value).change();
            });

            // Custom mode settings
            $(".custom-mode-checkbox").each(function (index, elem) {
                var elem_id = $(elem).attr("id");
                var form_id = "form_" + elem_id.replace(/-/g, "_");
                var key = "rom." + elem_id.replace(/-/g, "_");

                $(elem).change(function () {
                    $(".info").hide();
                    localforage.setItem(key, $(this).prop("checked"));
                    $("#" + form_id).val($(this).prop("checked"));
                });
                localforage.getItem(key).then(function (value) {
                    if (value === null) return;
                    $(elem).prop("checked", value).change();
                });
            });

            // Generate button
            $(".generate-btn").click(function () {
                $(".info").hide();
                $(this).html("Generating...").prop("disabled", true);
                resetRom().then(function (rom) {
                    applySeed(rom, $("#seed").val()).then(seedApplied, seedFailed);
                });
            });

            // Save ROM button
            $(".btn-save-rom").click(function () {
                return rom.save(rom.makeFilename("sfc"));
            });

            // Save WAD button
            $(".btn-save-wad").click(function () {
                rom.updateChecksum().then(function() {
                    $(".btn-save-wad").html("Generating...").prop("disabled", true);
                    $(".btn-save-rom").prop("disabled", true);

                    var fd = new FormData();
                    fd.append("region", rom.region);
                    fd.append("rom", rom.toBlob());
                    fd.append("wad", wad.toBlob());

                    $.ajax("{% url 'randomizer:pack' %}", {
                        method: "POST",
                        processData: false,
                        contentType: false,
                        dataType: 'binary',
                        data: fd,
                        xhrFields: {
                            responseType: 'blob'
                        },
                        success: function (result) {
                            var filename = rom.makeFilename("wad");
                            saveAs(result, filename);
                        },
                        error: function () {
                            $(".alert .message").html("Failed Packing Wad :(");
                            $(".alert").show().delay(2000).fadeOut("slow");
                        },
                        complete: function () {
                            $(".btn-save-wad").html("Save Wad").prop("disabled", false);
                            $(".btn-save-rom").prop("disabled", false);
                        }
                    });
                });
            });
        });
    </script>
{% endblock %}
