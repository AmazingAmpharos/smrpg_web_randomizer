{% extends 'randomizer/layouts/default.html' %}
{% load static %}

{% block content %}
    {% include 'randomizer/_rom_base.html' %}

    <div id="generate-container">
        {% include 'randomizer/_rom_loader.html' %}

        <div id="seed-generate" class="card border-success my-3" style="display:none">
            <div class="card-header bg-success text-white">
                <h3 class="card-title">Generate Randomized Game (v{{ version|default:'UNKNOWN' }})</h3>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <label for="mode" class="input-group-text">Randomization Mode</label>
                            </div>
                            <select id="mode" class="form-control multiselect">
                                <option value="full">Full</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="card border-primary collapse m-3" id="custom-mode-settings">
                        <div class="card-header bg-primary text-white">
                            <h4 class="card-title">Custom Mode Settings</h4>
                        </div>
                        <div class="card-body">
                            {% for flag in flags %}
                                <div class="card border-primary my-2">
                                    <div class="card-header">
                                        <input id="{{ flag.0 }}" type="checkbox" value="true" checked
                                               data-toggle="toggle"
                                               data-on="Yes" data-off="No" data-size="small" class="custom-mode-checkbox">
                                        <label for="{{ flag.0 }}">{{ flag.1 }}</label>
                                    </div>
                                    <div class="card-body">
                                        <p>{{ flag.2 }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <label for="seed" class="input-group-text">Seed</label>
                            </div>
                            <input type="text" id="seed" class="form-control" placeholder="random">
                            <div class="input-group-append">
                                <button id="seed-clear" class="btn" type="button">
                                    <span class="fas fa-trash-alt"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% include 'randomizer/_rom_settings.html' %}
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-md-6">
                        <div class="btn-group btn-flex" role="group">
                            <button name="generate" class="btn btn-success" id="generate-btn" disabled>Generate ROM</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="seed-details" class="card border-success my-3" style="display:none">
        <div class="card-header bg-success text-white">
            <h3 class="card-title float-left">Game Details</h3>
            <div class="btn-toolbar float-right">
                <button role="button" class="btn btn-light text-dark border-secondary" id="generate-another">
					Generate Another
                </button>
            </div>
        </div>
        <div class="card-body">
            {% include 'randomizer/_rom_info.html' with show_permalink=True %}
            <div class="col-md-6">
                <div role="group" class="btn-group btn-flex mr-3 mt-3">
                    <button name="save_rom" class="btn btn-success" id="btn-save-rom" disabled>Save Rom</button>
                </div>
                <div role="group" class="btn-group btn-flex mr-3 mt-3">
                    <button name="save_wad" class="btn btn-success" id="btn-save-wad" disabled>Save Wad</button>
                </div>
            </div>
        </div>
    </div>

    <form id="config" style="display:none">
        {% csrf_token %}
        <input type="hidden" name="region" id="form_region" value=""/>
        <input type="hidden" name="seed" id="form_seed" value=""/>
        <input type="hidden" name="mode" id="form_mode" value="full"/>
        {% for flag in flags %}
            <input type="hidden" name="{{ flag.0 }}" id="form_{{ flag.0 }}" value="true"/>
        {% endfor %}
        <input type="hidden" name="debug_mode" id="form_debug_mode" value="false"/>
    </form>

    <script>
        function applySeed(rom, seed) {
            return new Promise((resolve, reject) => {
                $("#form_region").val(rom.region);
                $("#form_seed").val(seed);
                $.post("{% url 'randomizer:generate' %}", $("#config").serialize(), (patch) => {
                    // TODO: Take mode from patch info.
                    rom.applyModeChanges("standard").then(() => {
                        rom.parsePatch(patch.patch);
                        resolve(patch);
                    });
                }, "json").fail(reject);
            });
        }

        function seedFailed() {
            $("#generate-btn").html("Generate ROM").prop("disabled", false);
            $("#error-message").html("Failed Creating Seed :(");
            $("#error-box").show().delay(2000).fadeOut("slow");
        }

        function seedApplied(patch) {
            return new Promise((resolve) => {
                $("#generate-btn").html("Generate").prop("disabled", false);
                $("#btn-save-rom").prop("disabled", false);
                if (wad.valid) {
                    $("#btn-save-wad").prop("disabled", false);
                } else {
                    $("#btn-save-wad").prop("disabled", true);
                }
                parseInfoFromPatch(patch);
                rom.logic = patch.logic;
                rom.mode = patch.mode;
                rom.debug_mode = patch.debug_mode;
                rom.seed = patch.seed;
                rom.hash = patch.hash;
                resolve(rom);
            });
        }

        $(() => {
            $("#seed-clear").click(() => {
                $("#seed").val("");
            });

            // Randomization mode
            $("#mode").change((event) => {
                $("#seed-details").hide();
                let mode = $(event.target).val();
                localforage.setItem("rom.mode", mode);
                $("#form_mode").val(mode);
                if (mode === "custom") {
                    $("#custom-mode-settings").collapse("show");
                } else {
                    $("#custom-mode-settings").collapse("hide");
                }
            }).change();

            localforage.getItem("rom.mode").then((value) => {
                if (value === null) {
                    return;
                }
                $("#mode").val(value).change();
            });

            // Custom mode settings
            $(".custom-mode-checkbox").each((index, elem) => {
                let elem_id = $(elem).attr("id");
                let form_id = "form_" + elem_id.replace(/-/g, "_");
                let key = "rom." + elem_id.replace(/-/g, "_");

                $(elem).change((event) => {
                    $("#seed-details").hide();
                    let checked = $(event.target).prop("checked");
                    localforage.setItem(key, checked);
                    $("#" + form_id).val(checked);
                });
                localforage.getItem(key).then((value) => {
                    if (value === null) {
                        return;
                    }
                    $(elem).prop("checked", value).change();
                });
            });

            // Generate button
            $("#generate-btn").click((event) => {
                $("#seed-details").hide();
                $(event.target).html("Generating...").prop("disabled", true);
                resetRom().then((rom) => {
                    applySeed(rom, $("#seed").val()).then(seedApplied, seedFailed);
                });
            });

            // Save ROM button
            $("#btn-save-rom").click(() => {
                return rom.save(rom.makeFilename("sfc"));
            });

            // Save WAD button
            $("#btn-save-wad").click(() => {
                rom.updateChecksum().then(() => {
                    $("#btn-save-wad").html("Generating...").prop("disabled", true);
                    $("#btn-save-rom").prop("disabled", true);

                    var fd = new FormData();
                    fd.append("region", rom.region);
                    fd.append("rom", rom.toBlob());
                    fd.append("wad", wad.toBlob());

                    $.ajax("{% url 'randomizer:pack' %}", {
                        method: "POST",
                        processData: false,
                        contentType: false,
                        dataType: 'binary',
                        data: fd,
                        xhrFields: {
                            responseType: 'blob',
                        },
                        success: (result) => {
                            var filename = rom.makeFilename("wad");
                            saveAs(result, filename);
                        },
                        error: () => {
                            $("#error-message").html("Failed Packing Wad :(");
                            $("#error-box").show().delay(2000).fadeOut("slow");
                        },
                        complete: () => {
                            $("#btn-save-wad").html("Save Wad").prop("disabled", false);
                            $("#btn-save-rom").prop("disabled", false);
                        },
                    });
                });
            });

            // Generate Another button
            $("#generate-another").click(() => {
                $("#seed-details").hide();
                $("#generate-container").show();
            })
        });
    </script>
{% endblock %}
